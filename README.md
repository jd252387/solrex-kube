# Solrex Reindex Platform (Quarkus)

This repository now contains three Gradle modules:

- `reindex-common`: shared request model (`ReindexRequest` and nested types)
- `reindex`: one-shot reindex worker app that executes a single reindex run
- `reindex-api`: asynchronous API that spawns Kubernetes Jobs to run reindex work

## Build and Test

```bash
./gradlew :reindex-common:test :reindex:test :reindex-api:test
```

## Build Container Images

Build worker image used by spawned Jobs:

```bash
./gradlew :reindex:quarkusBuild
docker build -f reindex/src/main/docker/Dockerfile.jvm -t solrex/reindex:latest reindex
```

Build API image with the exact tag generated in Quarkus Kubernetes manifest:

```bash
./gradlew :reindex-api:quarkusBuild
API_IMAGE=$(awk '/image: / {print $2; exit}' reindex-api/build/kubernetes/kubernetes.yml)
docker build -f reindex-api/src/main/docker/Dockerfile.jvm -t "$API_IMAGE" reindex-api
```

## Deploy to Kubernetes (local)

1. Ensure Solr + reindex worker RBAC prerequisites exist:

```bash
kubectl apply -f deploy/k8s/solr-dual-cluster.yaml
kubectl apply -f deploy/k8s/reindex-rbac.yaml
```

2. Deploy API resources generated by Quarkus Kubernetes integration:

```bash
kubectl apply -f reindex-api/build/kubernetes/kubernetes.yml
```

3. Apply API RBAC for Job/ConfigMap creation:

```bash
kubectl apply -f deploy/k8s/reindex-api-rbac.yaml
```

## Create Reindex Job (API)

```bash
curl -X POST http://reindex-api/api/v1/reindex/jobs \
  -H 'Content-Type: application/json' \
  -d '{
    "source": {
      "cluster": {"baseUrl": "http://solr-a:8983/solr", "requestTimeout": "PT30S"},
      "collection": "source_collection"
    },
    "target": {
      "cluster": {"baseUrl": "http://solr-b:8983/solr", "requestTimeout": "PT30S"},
      "collection": "target_collection"
    },
    "filters": {"query": "*:*", "fqs": []},
    "fields": ["id", "title", "category"],
    "tuning": {
      "readPageSize": 500,
      "writeBatchSize": 200,
      "writeConcurrency": 4,
      "retryPolicy": {
        "maxRetries": 3,
        "initialBackoff": "PT0.25S",
        "maxBackoff": "PT5S",
        "jitterFactor": 0.2
      }
    }
  }'
```

Successful response returns `202 Accepted` with generated `jobName` and `requestConfigMapName`.

## Verify Spawned Job

```bash
kubectl -n solrex get job
kubectl -n solrex get configmap | grep request
kubectl -n solrex logs job/<generated-job-name>
```
