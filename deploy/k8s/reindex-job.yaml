apiVersion: batch/v1
kind: Job
metadata:
  name: reindex-job
  namespace: solrex
spec:
  backoffLimit: 1
  ttlSecondsAfterFinished: 3600
  template:
    spec:
      serviceAccountName: reindex-job
      restartPolicy: Never
      containers:
        - name: reindex
          image: solrex/reindex:latest
          imagePullPolicy: IfNotPresent
          env:
            - name: QUARKUS_KUBERNETES_CONFIG_ENABLED
              value: "true"
            - name: QUARKUS_KUBERNETES_CONFIG_FAIL_ON_MISSING_CONFIG
              value: "true"
            - name: REINDEX_K8S_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: REINDEX_CONFIG_MAPS
              value: reindex-job-config
            - name: REINDEX_REQUEST_FILE
              value: /etc/reindex/request.yaml
          volumeMounts:
            - name: reindex-request
              mountPath: /etc/reindex
              readOnly: true
          resources:
            requests:
              cpu: "500m"
              memory: "1Gi"
            limits:
              cpu: "2"
              memory: "2Gi"
      volumes:
        - name: reindex-request
          configMap:
            name: reindex-job-config
            items:
              - key: request.yaml
                path: request.yaml
